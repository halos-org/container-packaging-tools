name: Build and Draft Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Read version from __init__.py
      id: version
      run: |
        VERSION=$(python3 -c "import sys; sys.path.insert(0, 'src'); from generate_container_packages import __version__; print(__version__)")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Check if release exists
      id: check_release
      run: |
        if gh release view "v${{ steps.version.outputs.version }}" &>/dev/null; then
          IS_DRAFT=$(gh release view "v${{ steps.version.outputs.version }}" --json isDraft --jq '.isDraft')
          if [ "$IS_DRAFT" = "true" ]; then
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "delete_existing=true" >> $GITHUB_OUTPUT
            echo "Existing draft release found - will delete and recreate"
          else
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "delete_existing=false" >> $GITHUB_OUTPUT
            echo "Published release v${{ steps.version.outputs.version }} already exists - skipping"
          fi
        else
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "delete_existing=false" >> $GITHUB_OUTPUT
          echo "No existing release found"
        fi
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Delete existing draft release
      if: steps.check_release.outputs.delete_existing == 'true'
      run: |
        echo "Deleting existing draft release v${{ steps.version.outputs.version }}"
        gh release delete "v${{ steps.version.outputs.version }}" --yes
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Install uv
      if: steps.check_release.outputs.skip == 'false'
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true

    - name: Install dependencies
      if: steps.check_release.outputs.skip == 'false'
      run: |
        uv pip install --system -e .[dev]

    - name: Run tests
      if: steps.check_release.outputs.skip == 'false'
      run: |
        pytest

    - name: Install Debian build tools
      if: steps.check_release.outputs.skip == 'false'
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-dev debhelper dh-python python3-all python3-setuptools

    - name: Build Debian package
      if: steps.check_release.outputs.skip == 'false'
      run: |
        dpkg-buildpackage -us -uc

    - name: Move packages to release directory
      if: steps.check_release.outputs.skip == 'false'
      run: |
        mkdir -p release-artifacts
        mv ../*.deb release-artifacts/ || echo "Warning: No .deb files found"
        mv ../*.buildinfo release-artifacts/ || echo "Warning: No .buildinfo files found"
        mv ../*.changes release-artifacts/ || echo "Warning: No .changes files found"
        ls -lh release-artifacts/

    - name: Create draft release
      if: steps.check_release.outputs.skip == 'false'
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        # Get the latest published release tag for changelog
        LAST_TAG=$(gh release list --limit 100 --json tagName,isPrerelease,isDraft --jq '.[] | select(.isDraft == false and .isPrerelease == false) | .tagName' | head -n1)

        if [ -n "$LAST_TAG" ]; then
          echo "Generating changelog since $LAST_TAG"
          CHANGELOG_COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
        else
          echo "No previous releases found, using recent commits"
          CHANGELOG_COMMITS=$(git log -10 --pretty=format:"- %s" --no-merges)
        fi

        # Create release notes
        cat > release_notes.md <<EOF
        ## Container Packaging Tools v${VERSION}

        Tooling for generating Debian packages from container application definitions.

        ### Changes

        ${CHANGELOG_COMMITS}

        ### Features

        - Generate Debian packages from simple container app definitions
        - Pydantic-based validation for app definitions
        - Jinja2 templates for Debian packaging files
        - Support for systemd services and AppStream metadata
        - Built-in quality checks and type checking

        ### Installation

        Download the \`.deb\` package from the assets below and install:

        \`\`\`bash
        sudo dpkg -i generate-container-packages_${VERSION}_all.deb
        sudo apt-get install -f  # Install any missing dependencies
        \`\`\`

        Or add our APT repository:

        \`\`\`bash
        curl -fsSL https://apt.hatlabs.fi/hat-labs-apt-key.asc | sudo gpg --dearmor -o /usr/share/keyrings/hatlabs.gpg
        echo "deb [signed-by=/usr/share/keyrings/hatlabs.gpg] https://apt.hatlabs.fi stable main" | sudo tee /etc/apt/sources.list.d/hatlabs.list
        sudo apt update
        sudo apt install generate-container-packages
        \`\`\`

        ### Development

        For development setup and build commands, see:
        - [README.md](https://github.com/hatlabs/container-packaging-tools/blob/main/README.md) - Project overview
        - [CLAUDE.md](https://github.com/hatlabs/container-packaging-tools/blob/main/CLAUDE.md) - Development guide
        - \`./run help\` - Available build and development commands
        EOF

        # Create the release with .deb files
        gh release create "v${VERSION}" \
          --draft \
          --title "v${VERSION}" \
          --notes-file release_notes.md \
          release-artifacts/*.deb

        echo "Created draft release v${VERSION}"
      env:
        GH_TOKEN: ${{ github.token }}
